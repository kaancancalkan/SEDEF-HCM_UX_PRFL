/*
 * Copyright (C) 2009-2018 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["com/sedef/hcm/ux/myprofile/controller/BaseController","com/sedef/hcm/ux/myprofile/utils/reuseHandler","com/sedef/hcm/ux/myprofile/utils/formatter","sap/ui/core/format/NumberFormat","sap/viz/ui5/format/ChartFormatter","sap/viz/ui5/controls/common/feeds/FeedItem","sap/viz/ui5/controls/VizFrame","sap/viz/ui5/data/FlattenedDataset","sap/ui/model/json/JSONModel","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/Carousel","sap/m/MessageStrip"],function(e,t,r,a,n,i,s,o,l,u,c,d,m){"use strict";return e.extend("com.sedef.hcm.ux.myprofile.blocks.PerformanceBlockController",{formatter:r,onInit:function(){var e=t.getOwnerComponent(),a=e.getModel("appProperties"),n=a.getProperty("/applicationController"),i=a.getProperty("/employeeId");this.oApplicationController=n;this.oResourceBundle=e.getModel("i18n").getResourceBundle();this.oLayout=this.byId("performanceVertLayout");this.oApplicationModel=a;this.oViewModel=new l({busy:false,chartOptions:null});this.setModel(this.oViewModel,"PerformanceView");this._initChartOptions();sap.ui.getCore().getEventBus().subscribe("com.sedef.hcm.ux.myprofile","employeeIdChanged",this.onEmployeeIdChange,this);n.whenMetadataLoaded(function(){this.oViewModel.setProperty("/busy",true);r.registerCustomVizFormat();this._readPerformanceData(i)}.bind(this))},onExit:function(){sap.ui.getCore().getEventBus().unsubscribe("com.sedef.hcm.ux.myprofile","employeeIdChanged",this.onEmployeeIdChange,this)},onEmployeeIdChange:function(e,t,r){this._readPerformanceData(r.EmployeeId)},onPlotAreaDataLabelRenderer:function(e,t){var r=this.byId(e),n=r.getDataset().getModel().getData().PerformanceRatings[t.ctx._context_row_number];if(n.ScaleArt==="M"){var i={},s="";if(n.UnitOfMeasurement==="%"){i=a.getPercentInstance({style:"short",minFractionDigits:0,maxFractionDigits:2});s=i.format(n.PerformanceRating/100)}else{i=a.getFloatInstance({style:"short",minFractionDigits:0,maxFractionDigits:2});s=i.format(n.PerformanceRating)+" "+n.UnitOfMeasurement}t.text=s}else{t.text=n.PerformanceRatingText}},_readPerformanceData:function(e){this.oApplicationController.getODataHelper().read("/PerformanceSet",this._handleSuccessV2.bind(this),[new u("EmployeeNumber",c.EQ,e)])},_handleSuccessV2:function(e){this._adjustChart(e)},_handleSuccess:function(e){this.oLayout.destroyContent();if(!e.results||e.results&&e.results.length===0){var t=this.oApplicationModel.getProperty("/oConfigData"),r=t.PerformanceDuration?jQuery.sap.formatMessage(this.oResourceBundle.getText("noPerformanceTxtDate"),[t.PerformanceDuration.DurationYears]):this.oResourceBundle.getText("noPerformanceTxt"),a=new m(this.createId("noPerformanceStrip"),{tooltip:r,text:r,type:sap.ui.core.MessageType.Information,showIcon:true});this.oLayout.addContent(a)}else{var n=this._groupResultItemsPerScale(e.results);if(n.length>1){var i=new d(this.createId("perfCarousel"),{loop:false,showPageIndicator:true,arrowsPlacement:sap.m.CarouselArrowsPlacement.Content});this.oLayout.addContent(i)}n.forEach(function(e,t,r){if(i){var a=this._buildVizFrame(e.performanceItems);i.addPage(a);if(t+1===r.length){i.setActivePage(a)}}else{this.oLayout.addContent(this._buildVizFrame(e.performanceItems))}}.bind(this))}this.oViewModel.setProperty("/busy",false)},_buildVizFrame:function(e){var t=Math.max.apply(Math,e.map(function(e){return parseInt(e.MaxScaleLevel,10)})),a=Math.min.apply(Math,e.map(function(e){return parseInt(e.MinScaleLevel,10)})),n=e[0].ScaleText;e.forEach(function(e){e.Period=r.formatPeriod(e.BeginDate,e.EndDate)});var u=new l({PerformanceRatings:e});var c=this.createId("perfVizFrame"+e[0].ScaleId);var d=new s(c,{uiConfig:{applicationSet:"fiori"},vizType:"line",width:"100%"});d.setVizProperties({plotArea:{dataLabel:{showTotal:true,visible:true,hideWhenOverlap:false,renderer:function(e){this.onPlotAreaDataLabelRenderer(c,e)}.bind(this)},primaryScale:{autoMaxValue:true,autoMinValue:true}},legend:{visible:false},valueAxis:{visible:true,label:{formatString:e[0].ScaleArt==="M"?r.FIORI_LABEL_PERCENTAGEFORMAT:""},title:{text:this.oResourceBundle.getText("performanceAppraisalRatingMeasure"),visible:true}},categoryAxis:{visible:true,title:{text:this.oResourceBundle.getText("performancePeriodDimension"),visible:true}},title:{text:n,visible:true},interaction:{selectability:{mode:"exclusive",legendSelection:false,axisLabelSelection:false,plotLassoSelection:false,plotStdSelection:true}}});d.setVizScales([{feed:"valueAxis",max:t,min:a}]);var m=new o({dimensions:[{name:"Period",value:"{Period}"}],measures:[{name:"PerformanceRating",value:"{PerformanceRating}"}],data:{path:"/PerformanceRatings"}});d.setDataset(m);d.setModel(u);var f=new i({uid:"valueAxis",type:"Measure",values:["PerformanceRating"]}),p=new i({uid:"categoryAxis",type:"Dimension",values:["Period"]});d.addFeed(f);d.addFeed(p);return d},_groupResultItemsPerScale:function(e){var t=e.reduce(function(e,t){e[t.ScaleId]=e[t.ScaleId]||[];e[t.ScaleId].push(t);return e},{});var r=Object.keys(t).map(function(e){return{scaleId:e,performanceItems:t[e]}});return r},_rerenderGraph:function(){this.byId("idPerformanceGraph").rerender()},_adjustChart:function(e){var t=this;t._initChartOptions();var r=this.oViewModel.getProperty("/chartOptions");var a=_.find(e.results,["ScaleId","00000100"])?true:false;var n=_.find(e.results,["ScaleId","00000101"])?true:false;if(n){r.colors.push("#FEB019");r.series.push({name:"Sendikalı",type:"bar",data:[]});r.yaxis.push({seriesName:"Sendikalı",showForNullSeries:false,opposite:false,axisTicks:{show:false},axisBorder:{show:true},labels:{formatter:function(e){if(e>=0){switch(e){case 1:return"Beklenenin Altında -";case 2:return"Beklenenin altında";case 3:return"Gelişim İhtiyacı Olan";case 4:return"Gelişim İhtiyacı Olan +";case 5:return"Beklenen Seviye";case 6:return"Beklenen Seviye +";case 7:return"Beklenenin Üzerinde";default:return null}}else{return e}}},title:{text:"Sendikalı",offsetX:5,style:{fontSize:"11px"}},tickAmount:7,min:0,max:7})}if(a){r.colors.push("#008FFB");r.series.push({name:"Sendikasız",type:"bar",data:[]});r.yaxis.push({seriesName:"Sendikasız",showForNullSeries:false,opposite:n?true:false,axisTicks:{show:false},axisBorder:{show:true},labels:{formatter:function(e){if(e>=0){switch(e){case 1:return"Beklenenin altında";case 2:return"Beklenen";case 3:return"Beklenenin üzerinde";case 4:return"Beklenenin çok üzerinde";default:return null}}else{return e}}},title:{text:"Sendikasız",offsetX:5,style:{fontSize:"11px"}},tooltip:{enabled:true},tickAmount:4,min:0,max:4})}$.each(e.results,function(e,t){r.xaxis.categories.push(parseInt(t.PerformanceYear,10));switch(t.ScaleId){case"00000101":r.series[0].data.push(parseInt(t.PerformanceRating,10));if(a)r.series[1].data.push(null);break;case"00000100":if(n){r.series[0].data.push(null);r.series[1].data.push(parseInt(t.PerformanceRating,10))}else{r.series[0].data.push(parseInt(t.PerformanceRating,10))}break;default:}});this.oViewModel.setProperty("/chartOptions",r)},_initChartOptions:function(){var e={series:[],colors:[],chart:{offsetX:20,width:"90%",height:350,type:"bar",stacked:true,toolbar:{show:false,offsetX:0,offsetY:0,tools:{download:true,selection:true,zoom:true,zoomin:true,zoomout:true,pan:true,reset:true,customIcons:[]},autoSelected:"zoom"}},plotOptions:{bar:{borderRadius:[3,3],dataLabels:{position:"top"},columnWidth:"10%"}},dataLabels:{enabled:false},stroke:{width:[1,1],curve:"smooth"},title:{text:"Performans Değerlendirme Sonuçları",align:"center"},markers:{size:2,strokeColors:"#0ee",strokeWidth:2,strokeOpacity:.9},xaxis:{categories:[]},yaxis:[],legend:{horizontalAlign:"center"}};this.oViewModel.setProperty("/chartOptions",e)},_initChartOptionsX:function(){var e={series:[{name:"Sendikasız",type:"bar",data:[]},{name:"Sendikalı",type:"bar",data:[]}],theme:{palette:"palette2"},chart:{height:350,type:"bar",stacked:true,toolbar:{show:false,offsetX:0,offsetY:0,tools:{download:true,selection:true,zoom:true,zoomin:true,zoomout:true,pan:true,reset:true,customIcons:[]},autoSelected:"zoom"}},plotOptions:{bar:{borderRadius:[10,10],dataLabels:{position:"top"},columnWidth:"15%"}},dataLabels:{enabled:false},stroke:{width:[1,1],curve:"smooth"},title:{text:"Performans Değerlendirme Sonuçları",align:"center"},markers:{size:2,strokeColors:"#0ee",strokeWidth:2,strokeOpacity:.9},xaxis:{categories:[]},yaxis:[{seriesName:"Sendikasız",showForNullSeries:false,axisTicks:{show:false},axisBorder:{show:true},labels:{formatter:function(e){if(e>=0){switch(e){case 1:return"Beklenenin altında";case 2:return"Beklenen";case 3:return"Beklenenin üzerinde";case 4:return"Beklenenin çok üzerinde";default:return null}}else{return e}}},title:{text:"Sendikasız"},tooltip:{enabled:true},tickAmount:4,min:0,max:4},{seriesName:"Sendikalı",showForNullSeries:false,opposite:true,axisTicks:{show:false},axisBorder:{show:true},labels:{formatter:function(e){if(e>=0){switch(e){case 1:return"Beklenenin Altında -";case 2:return"Beklenenin altında";case 3:return"Gelişim İhtiyacı Olan";case 4:return"Gelişim İhtiyacı Olan +";case 5:return"Beklenen Seviye";case 6:return"Beklenen Seviye +";case 7:return"Beklenenin Üzerinde";default:return null}}else{return e}}},title:{text:"Sendikalı"},tickAmount:7,min:0,max:7}],legend:{horizontalAlign:"center"}};this.oViewModel.setProperty("/chartOptions",e)}})});
//# sourceMappingURL=PerformanceBlockController.controller.js.map