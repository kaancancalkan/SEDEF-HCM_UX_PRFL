/*
 * Copyright (C) 2009-2018 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["com/sedef/hcm/ux/myprofile/controller/BaseController","com/sedef/hcm/ux/myprofile/controller/ErrorHandler","sap/ui/model/json/JSONModel","sap/m/GroupHeaderListItem","hcm/fab/lib/common/util/CommonModelManager","com/sedef/hcm/ux/myprofile/utils/formatter","com/sedef/hcm/ux/myprofile/utils/reuseHandler","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,o,i,s,a,n,r,l){"use strict";return e.extend("com.sedef.hcm.ux.myprofile.controller.ProfileOverview",{formatter:a,reuseHandler:n,extHookAdjustObjectPageHeader:null,onInit:function(){var e=this.getView().byId("pageHeader"),t=(new sap.ui.core.Configuration).getVersion(),i=new o({showOnlyObjAttrRepTo:t.compareTo(1,48)<0?false:true}),s=new o({showTimeSection:false,showSkillsProgress:false,showTalentSection:false,showQualifications:false,showTrainings:false,showPerformanceRatings:false,showCareerProgress:false,showCompensationSection:false,showPaystubs:false,showSalary:false,showPersInfoSection:false,showEmployeeSkills:true,showPersonalData:false,showAddressData:false,showBankData:false,showFamilyMembersData:false,showCommunicationData:false,showEducationData:false,showWorkExperienceData:true,showForeignLanguageData:true,showCourseData:true,showCertificateData:true,showInternalData:false,sPersonalDataSubSectionTitle:null,sAddressSubSectionTitle:null,sBankDetailsSubSectionTitle:null,sFamilyMembersSubSectionTitle:null,sCommunicationDataSubSectionTitle:null,sInternalDataSubSectionTitle:null,sEducationSubSectionTitle:null,otherEmployeeProfiles:false,bAuthEditAddress:false,bAuthEditWorkExperince:false,bAuthEditForeignLanguage:false,bAuthEditCourse:false,bAuthEditCertificate:false});this.oOwnerComponent=this.getOwnerComponent();this.setModel(i,"ProfileView");this.oViewModel=i;this.setModel(s,"ConfigView");this.oConfigModel=s;this.oApplicationModel=this.oOwnerComponent.getModel("appProperties");this.oApplicationController=this.oApplicationModel.getProperty("/applicationController");this.oMetaModel=this.oApplicationController.getODataHelper().getMetaModel();this._oManagerQuickView=null;this._oOfficeInfoQuickView=null;this.oObjectPageLayout=this.byId("profileOverviewLayout");this.getRouter().getRoute("profileOverview").attachPatternMatched(this._onObjectMatched,this);if(this.extHookAdjustObjectPageHeader){this.extHookAdjustObjectPageHeader(e)}},onAssignmentChange:function(e){var t=e.getParameter("selectedAssignment");this.oApplicationModel.setProperty("/employeeId",t);this._processEmployeeId(t);sap.ui.getCore().getEventBus().publish("com.sedef.hcm.ux.myprofile","employeeIdChanged",{EmployeeId:t})},onManagerPress:function(e){var t=this._getManagerQuickView();t.openBy(e.getSource())},onOfficeInfoPress:function(e){var t=this._getOfficeInfoQuickView();t.openBy(e.getSource())},onTitleSelectorPress:function(e){var t=this._getColleaguesPopover();t.openBy(e.getParameter("domRef"))},onNavToEmployeeLookup:function(e){this.oApplicationController.navToExternal(this.oApplicationController.getCrossAppNavIntends().EMPLOYEELOOKUP.target,this.oApplicationModel.getProperty("/employeeId"))},onColleaguesPress:function(e){this._oColleaguesPopover.close();var t=e.getSource().getBindingContext().getProperty("EmployeeNumber");this.oApplicationModel.setProperty("/employeeId",t);this._processEmployeeId(t);sap.ui.getCore().getEventBus().publish("com.sedef.hcm.ux.myprofile","employeeIdChanged",{EmployeeId:t})},onNavBack:function(){this.oApplicationController.navBack("",true)},onPhoneClick:function(e){sap.m.URLHelper.triggerTel(e.getSource().getText())},onEmailClick:function(e){sap.m.URLHelper.triggerEmail(e.getSource().getText())},onEmployeeSuggestionSelected:function(e){},onSuggestEmployee:function(e){var t=e.getParameter("suggestValue");var o=e.getSource();var i=[];if(t){i=[new r("Query",l.EQ,t)]}var s=o.getBinding("suggestionItems");s.filter(i);s.attachEventOnce("dataReceived",function(){o.suggest()})},onSearchEmployee:function(e){var t=e.getParameter("suggestionItem");if(t){var o=t.getKey();this.oApplicationModel.setProperty("/employeeId",o);this._processEmployeeId(o);sap.ui.getCore().getEventBus().publish("com.sedef.hcm.ux.myprofile","employeeIdChanged",{EmployeeId:o})}else{this.oApplicationController.whenMetadataLoaded(function(){s.getDefaultAssignment().then(function(e){this.oApplicationModel.setProperty("/employeeId",e.EmployeeId);this.oApplicationModel.setProperty("/defaultVersionId",e.DefaultVersionId);this.oApplicationController.loadEmployeeDataModelForEmployeeId(e.EmployeeId);this._processEmployeeId(e.EmployeeId);sap.ui.getCore().getEventBus().publish("com.sedef.hcm.ux.myprofile","employeeIdChanged",{EmployeeId:e.EmployeeId})}.bind(this))}.bind(this))}},_onObjectMatched:function(e){this.oApplicationController.whenMetadataLoaded(function(){s.getDefaultAssignment().then(function(e){this.oApplicationModel.setProperty("/employeeId",e.EmployeeId);this.oApplicationModel.setProperty("/defaultEmployeeId",e.EmployeeId);this.oApplicationModel.setProperty("/defaultVersionId",e.DefaultVersionId);this.oApplicationController.loadEmployeeDataModelForEmployeeId(e.EmployeeId);this._processEmployeeId(e.EmployeeId)}.bind(this))}.bind(this))},_processEmployeeId:function(e){var t=this.oApplicationController.getODataHelper(),o="/"+t.getObjectPath(e,"ConfigurationSet"),i=function(t){this.oApplicationModel.setProperty("/oConfigData",t);this._updateModelsFromConfig(e,t);this._adjustSectionsFromConfig(t);this._bindView(e,t)}.bind(this);t.read(o,i)},_updateModelsFromConfig:function(e,t){this._updateConfigModel(t);this._updateApplicationModel(e,t)},_updateConfigModel:function(e){this.oConfigModel.setProperty("/showTimeSection",e.ShowTimebalance||e.ShowTimerecording||e.ShowAbsence);this.oConfigModel.setProperty("/showTalentSection",e.ShowTrainings||e.ShowQualifications||e.ShowPerformanceRatings||e.ShowCareerProgress);this.oConfigModel.setProperty("/showCompensationSection",e.ShowSalary||e.ShowPaystubs);this.oConfigModel.setProperty("/showPersInfoSection",e.ShowAddressData||e.ShowPersonalData||e.ShowBankData||e.ShowFamilymembersData||e.ShowCommunicationData||e.ShowInternalData||e.ShowEducationData);this.oConfigModel.setProperty("/otherEmployeeProfiles",e.OtherEmployeeProfiles);this.oConfigModel.setProperty("/showTrainings",e.ShowTrainings);this.oConfigModel.setProperty("/showQualifications",e.ShowQualifications);this.oConfigModel.setProperty("/showPerformanceRatings",e.ShowPerformanceRatings);this.oConfigModel.setProperty("/showCareerProgress",e.ShowCareerProgress);this.oConfigModel.setProperty("/showPaystubs",e.ShowPaystubs);this.oConfigModel.setProperty("/showSalary",e.ShowSalary);this.oConfigModel.setProperty("/showPersonalData",e.ShowPersonalData);this.oConfigModel.setProperty("/showBankData",e.ShowBankData);this.oConfigModel.setProperty("/showAddressData",e.ShowAddressData);this.oConfigModel.setProperty("/showFamilyMembersData",e.ShowFamilymembersData);this.oConfigModel.setProperty("/showCommunicationData",e.ShowCommunicationData);this.oConfigModel.setProperty("/showInternalData",e.ShowInternalData);this.oConfigModel.setProperty("/showEducationData",e.ShowEducationData);this.oConfigModel.setProperty("/sPersonalDataSubSectionTitle",e.PersonalDataSubsectionTitle);this.oConfigModel.setProperty("/sAddressSubSectionTitle",e.AddressSubsectionTitle);this.oConfigModel.setProperty("/sBankDetailsSubSectionTitle",e.BankdetailsSubsectionTitle);this.oConfigModel.setProperty("/sFamilyMembersSubSectionTitle",e.FamilymembersSubsectionTitle);this.oConfigModel.setProperty("/sInternalDataSubSectionTitle",e.InternaldataSubsectionTitle);this.oConfigModel.setProperty("/sCommunicationDataSubSectionTitle",e.CommunicationSubsectionTitle);this.oConfigModel.setProperty("/sEducationSubSectionTitle",e.EducationSubsectionTitle);this.oConfigModel.setProperty("/bAuthEditAddress",e.AuthEditAddress);this.oApplicationModel.setProperty("/bAuthEditAddress",e.AuthEditAddress);this.oConfigModel.setProperty("/bAuthEditWorkExperience",e.AuthEditWorkExperience);this.oConfigModel.setProperty("/bAuthEditForeignLanguage",e.AuthEditForeignLanguage);this.oConfigModel.setProperty("/bAuthEditCourse",e.AuthEditCourse);this.oConfigModel.setProperty("/bAuthEditCertificate",e.AuthEditCertificate)},_updateApplicationModel:function(e,t){this.oApplicationController.loadEmployeeDataModelForEmployeeId(e)},_createId:function(e){if(e){return this.oView.getId()+"--"+e}return this.oView.getId()},_adjustSectionsFromConfig:function(e){var t=this._getSections();this.oObjectPageLayout.removeAllSections();t.forEach(function(t){if(this._isSectionVisible(t)){var o=t.getId();if(o===this._createId("timeSection")){this._removeUnusedTimeBlocks(t,e)}if(o===this._createId("personalInformationSection")){this._removeUnusedPersInfoSubSections(t,e)}this.oObjectPageLayout.addSection(t)}else{this.oObjectPageLayout.addDependent(t)}}.bind(this))},_getSections:function(){if(!this._aSections){this._aSections=sap.ui.xmlfragment(this._createId(),"com.sedef.hcm.ux.myprofile.view.fragment.ObjectPageSections",this)}return this._aSections},_isSectionVisible:function(e){var t=e.getId();if(t===this._createId("timeSection")){return this.oConfigModel.getProperty("/showTimeSection")}if(t===this._createId("talentSection")){return this.oConfigModel.getProperty("/showTalentSection")}if(t===this._createId("personalInformationSection")){return this.oConfigModel.getProperty("/showPersInfoSection")}if(t===this._createId("compensationSection")){return this.oConfigModel.getProperty("/showCompensationSection")}return true},_removeUnusedTimeBlocks:function(e,t){if(this.oConfigModel.getProperty("/showTimeSection")){var o=e.getSubSections()[0];if(!t.ShowTimerecording){try{o.removeBlock(this._createId("timeRecordingBlock")).destroy()}catch(e){}}if(!t.ShowTimebalance){try{o.removeBlock(this._createId("timeBalanceBlock")).destroy()}catch(e){}}if(!t.ShowAbsence){try{o.removeBlock(this._createId("absenceBlock")).destroy()}catch(e){}}}},_removeUnusedPersInfoSubSections:function(e,t){if(this.oConfigModel.getProperty("/showPersInfoSection")){if(!t.ShowPersonalData){try{e.removeSubSection(this._createId("personalDataSubSection")).destroy()}catch(e){}}if(!t.ShowAddressData){try{e.removeSubSection(this._createId("addressesSubSection")).destroy()}catch(e){}}if(!t.ShowBankData){try{e.removeSubSection(this._createId("bankSubSection")).destroy()}catch(e){}}if(!t.ShowFamilymembersData){try{e.removeSubSection(this._createId("familyMembersSubSection")).destroy()}catch(e){}}if(!t.ShowCommunicationData){try{e.removeSubSection(this._createId("communicationDataSubSection")).destroy()}catch(e){}}}},_bindView:function(e,t){var o="/"+this.oApplicationController.getODataHelper().getObjectPath(e,"EmployeeDetailSet"),i=this.oApplicationController.getAppNavProperties(),s=this._buildExpandStringForEmployeeDetails(t);this.oApplicationModel.setProperty("/viewObjectPath",o);this.oApplicationModel.setProperty("/viewExpandParameters",s);n.setView(this.getView());this.oApplicationController.whenMetadataLoaded(function(){this.getView().bindElement({path:o,parameters:{expand:s},events:{dataRequested:function(){this.oApplicationModel.setProperty("/isAppBusy",true)}.bind(this),dataReceived:function(t){var o=t.getParameter("data"),s=this.oApplicationController.getEmployeeDataModelForEmployeeId(e);try{this.oApplicationModel.setProperty("/addressInfoMetaData",o["toAddresses"][0].toPersInfoMetaData)}catch(e){jQuery.sap.log.error("No metadata for address")}s.setProperty("/bCareerProgressExist",this._dataSetExists(o,i.CAREERPROGRESS));s.setProperty("/bQualificationsExist",this._dataSetExists(o,i.QUALIFICATIONS));s.setProperty("/bTrainingsExist",this._dataSetExists(o,i.TRAININGS));s.setProperty("/bPaystubsExist",this._dataSetExists(o,i.PAYSTUBS));s.setProperty("/bPersInfoPersonalDataExists",this._dataSetExists(o,i.PERSONALDATA));s.setProperty("/bPersInfoBankDataExists",this._dataSetExists(o,i.BANKDETAIL));s.setProperty("/bPersInfoAddressExists",this._dataSetExists(o,i.ADDRESSES));s.setProperty("/bPersInfoFamilyMembersExists",this._dataSetExists(o,i.FAMILYMEMBERS));s.setProperty("/bPersInfoCommunicationDataExists",this._dataSetExists(o,i.COMMUNICATION));s.setProperty("/bPersInfoInternalDataExists",this._dataSetExists(o,i.INTERNALDATA));s.setProperty("/bEducationExist",this._dataSetExists(o,i.EDUCATION));s.setProperty("/bPerformanceExist",this._dataSetExists(o,i.PERFORMANCE));s.setProperty("bMultipleSkillsExist",this._dataSetExists(o,i.EMPLOYEESKILL));s.setProperty("/bWorkExperienceExist",this._dataSetExists(o,i.WORKEXPERIENCE));s.setProperty("/bForeignLanguageExist",this._dataSetExists(o,i.FOREIGNLANGUAGE));s.setProperty("/bCourseExist",this._dataSetExists(o,i.COURSE));s.setProperty("/bCertificateExist",this._dataSetExists(o,i.CERTIFICATE));this.oApplicationModel.setProperty("/isAppBusy",false)}.bind(this)}})}.bind(this))},_buildExpandStringForEmployeeDetails:function(e){var t=this.oApplicationController.getAppNavProperties(),o=t.COLLEAGUES+","+t.COLLEAGUES+"/"+t.EMPLOYEEPICTURE+","+t.EMPLOYEEPICTURE+","+t.MANAGERDETAIL+"/"+t.EMPLOYEEPICTURE,i="",s=this.oApplicationModel.getProperty("/schemaNamespace");var a=this.oMetaModel.getODataEntityType(s+".EmployeeDetail");a.navigationProperty.forEach(function(o){if(o.name!==t.COLLEAGUES&&o.name!==t.EMPLOYEEPICTURE&&o.name!==t.MANAGERDETAIL&&(o.name===t.ABSENCE&&e.ShowAbsence||o.name===t.TIMEBALANCE&&e.ShowTimebalance||o.name===t.TIMERECORDING&&e.ShowTimerecording||o.name===t.TRAININGS&&e.ShowTrainings||o.name===t.CAREERPROGRESS&&e.ShowCareerProgress||o.name===t.QUALIFICATIONS&&e.ShowQualifications||o.name===t.PAYSTUBS&&e.ShowPaystubs||o.name===t.ADDRESSES&&e.ShowAddressData||o.name===t.PERSONALDATA&&e.ShowPersonalData||o.name===t.BANKDETAIL&&e.ShowBankData||o.name===t.FAMILYMEMBERS&&e.ShowFamilymembersData||o.name===t.COMMUNICATION&&e.ShowCommunicationData||o.name===t.INTERNALDATA&&e.ShowInternalData||o.name===t.EDUCATION&&e.ShowEducationData||o.name===t.WORKEXPERIENCE||o.name===t.FOREIGNLANGUAGE||o.name===t.COURSE||o.name===t.PERFORMANCE||o.name===t.EMPLOYEESKILL||o.name===t.CERTIFICATE)){if(o.name===t.PERSONALDATA||o.name===t.BANKDETAIL||o.name===t.FAMILYMEMBERS||o.name===t.ADDRESSES||o.name===t.COMMUNICATION||o.name===t.INTERNALDATA||o.name===t.EDUCATION){i=i.toString()+","+o.name+"/toPersInfoMetaData";if(o.name===t.ADDRESSES){i=i.toString()+","+o.name+"/toAddressChangeRequest";i=i.toString()+","+o.name+"/toAddressChangeRequest/toAttachments"}}else{i=i.toString()+","+o.name}}});return o+i},_dataSetExists:function(e,t){if(e[t]&&e[t]instanceof Array&&e[t].length!==0){return true}return false},_getManagerQuickView:function(){if(!this._oManagerQuickView){var e=this.getView();this._oManagerQuickView=sap.ui.xmlfragment("com.sedef.hcm.ux.myprofile.view.fragment.ManagerQuickview",this);jQuery.sap.syncStyleClass(this.getOwnerComponent().getContentDensityClass(),e,this._oManagerQuickView);e.addDependent(this._oManagerQuickView)}return this._oManagerQuickView},_getColleaguesPopover:function(){if(!this._oColleaguesPopover){var e=this.getView();this._oColleaguesPopover=sap.ui.xmlfragment("com.sedef.hcm.ux.myprofile.view.fragment.ColleaguesList",this);jQuery.sap.syncStyleClass(this.getOwnerComponent().getContentDensityClass(),e,this._oColleaguesPopover);e.addDependent(this._oColleaguesPopover)}else{var t=sap.ui.getCore().byId("colleaguesList");t.getBinding("items").refresh()}return this._oColleaguesPopover},_getDirectReportsPopover:function(){if(!this._oDirectReportsPopover){var e=this.getView();this._oDirectReportsPopover=sap.ui.xmlfragment("com.sedef.hcm.ux.myprofile.view.fragment.DirectReportsList",this);jQuery.sap.syncStyleClass(this.getOwnerComponent().getContentDensityClass(),e,this._oDirectReportsPopover);e.addDependent(this._oDirectReportsPopover)}return this._oDirectReportsPopover},_groupByEmployeeCategory:function(e){return e.getProperty("EmployeeCategory")},_getGroupHeader:function(e){var t="";switch(e.key){case"BOSS":t=this.getResourceBundle().getText("colleagueListGroupTitleManager");break;case"COLLEAGUE":t=this.getResourceBundle().getText("colleagueListGroupTitleColleague");break;case"DIRECTREPORT":t=this.getResourceBundle().getText("colleagueListGroupTitleDirectReport");break}return new i({title:t,upperCase:false})},_getOfficeInfoQuickView:function(){if(!this._oOfficeInfoQuickView){var e=this.getView();this._oOfficeInfoQuickView=sap.ui.xmlfragment("com.sedef.hcm.ux.myprofile.view.fragment.OfficeInfoQuickview",this);jQuery.sap.syncStyleClass(this.getOwnerComponent().getContentDensityClass(),e,this._oOfficeInfoQuickView);this.getView().addDependent(this._oOfficeInfoQuickView)}return this._oOfficeInfoQuickView},onCloseAddressDialog:function(e){e.getSource().getParent().close()},onNewWorkExperience:function(e){var t=sap.ui.getCore().getEventBus();var o=this;o.getModel().metadataLoaded().then(function(){o.oApplicationController.whenMetadataLoaded(function(){t.publish("WorkExperience","Create",null)})})},onNewForeignLanguage:function(e){var t=sap.ui.getCore().getEventBus();var o=this;o.getModel().metadataLoaded().then(function(){o.oApplicationController.whenMetadataLoaded(function(){t.publish("ForeignLanguage","Create",null)})})},onNewCourse:function(e){var t=sap.ui.getCore().getEventBus();var o=this;o.getModel().metadataLoaded().then(function(){o.oApplicationController.whenMetadataLoaded(function(){t.publish("Course","Create",null)})})},onNewCertificate:function(e){var t=sap.ui.getCore().getEventBus();var o=this;o.getModel().metadataLoaded().then(function(){o.oApplicationController.whenMetadataLoaded(function(){t.publish("Certificate","Create",null)})})}})});
//# sourceMappingURL=ProfileOverview.controller.js.map